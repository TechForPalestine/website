---
import Layout from "../layouts/Layout.astro";
import "../styles/base.css";

// Get country from Cloudflare headers
const country = Astro.request.headers.get('cf-ipcountry') || 'UNKNOWN';
const isUK = country === 'GB';
---

<Layout title="Donate">
  <div class="relative bg-gradient-to-b from-green-50 via-white to-blue-50">
    <div class="mx-auto max-w-5xl px-4 py-12 sm:px-6 sm:py-16 lg:px-8">
      <!-- Hero -->
      <div class="text-center">
        <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl md:text-5xl">
          Support Tech for Palestine
        </h1>
        <p class="mx-auto mt-5 max-w-3xl text-lg text-gray-700">
          Since launching Tech for Palestine, we've helped bring impactful projects to life: Media
          Bias Meter, Boycat, Find a Protest, Newscord, and many more.
        </p>
        <p class="mx-auto mt-3 max-w-3xl text-lg text-gray-600">
          Your donation helps us hire professionals, strengthen existing projects, and launch new
          initiatives for a free Palestine.
        </p>

        <!-- Highlights -->
        <div class="mx-auto mt-8 grid max-w-3xl grid-cols-1 gap-4 sm:grid-cols-3">
          <div
            class="flex items-center space-x-3 rounded-lg border border-gray-200 bg-white/70 px-4 py-3"
          >
            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-green-100">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-green-700"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <span class="font-medium text-gray-700">Hire professionals</span>
          </div>
          <div
            class="flex items-center space-x-3 rounded-lg border border-gray-200 bg-white/70 px-4 py-3"
          >
            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-blue-100">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-blue-700"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h4l3 10 4-18 3 8h4"
                ></path>
              </svg>
            </div>
            <span class="font-medium text-gray-700">Strengthen projects</span>
          </div>
          <div
            class="flex items-center space-x-3 rounded-lg border border-gray-200 bg-white/70 px-4 py-3"
          >
            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-purple-100">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-purple-700"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <span class="font-medium text-gray-700">Launch new initiatives</span>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="mt-12 grid grid-cols-1 gap-8 lg:grid-cols-3">
        <!-- Donation Card -->
        <div class="lg:col-span-2">
          <div
            class="rounded-2xl border border-gray-200 bg-white/80 p-6 shadow-md backdrop-blur sm:p-8"
          >
            <h2 class="mb-4 text-center text-xl font-semibold text-gray-800">Make a donation</h2>
            <div class="mx-auto w-full max-w-lg">
              <!-- Variant A: Qgiv Form Only (no link) -->
              <div id="form-qgiv-only" style="display: none;">
                <div
                  class="qgiv-embed-container"
                  data-qgiv-embed="true"
                  data-embed-id="83460"
                  data-embed="https://secure.qgiv.com/for/techforpalestine-websitedonationform/embed/83460/amount/1620629/recurring/"
                  data-width="630"
                >
                </div>
              </div>

              <!-- Variant B Non-UK: Qgiv Form + Link to ValidAid -->
              <div id="form-qgiv-link" style="display: none;">
                <p class="mb-4 text-center text-sm text-gray-700">
                  If you are in the UK, <a href="?variant=validaid" class="font-semibold text-green-700 underline hover:text-green-800">click here to donate with Gift Aid</a>.
                </p>
                <div
                  class="qgiv-embed-container"
                  data-qgiv-embed="true"
                  data-embed-id="83460"
                  data-embed="https://secure.qgiv.com/for/techforpalestine-websitedonationform/embed/83460/amount/1620629/recurring/"
                  data-width="630"
                >
                </div>
              </div>

              <!-- Variant B UK: ValidAid Form + Link to Qgiv -->
              <div id="form-validaid-link" style="display: none;">
                <p class="mb-4 text-center text-sm text-gray-700">
                  Not in the UK? <a href="?variant=qgiv" class="font-semibold text-green-700 underline hover:text-green-800">Click here to donate</a>.
                </p>
                <iframe
                  id="validaid-iframe-event-236"
                  src="https://validaid.org/embed/event/236"
                  title="Tech for Palestine"
                  style="width:100%; border:none;"
                  allow="payment"
                ></iframe>
              </div>
            </div>
            <p class="mt-4 text-center text-sm text-gray-500">
              If this page isn't loading, please use <a href="/donate-2" class="text-green-700 underline hover:text-green-800">this form</a>.
            </p>
            <div
              class="mt-5 flex flex-col items-center justify-center gap-3 text-sm text-gray-600 sm:flex-row"
            >
              <div class="flex items-center">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="mr-2 h-4 w-4 text-green-700"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                501(c)(3) nonprofit
              </div>
              <span class="hidden sm:inline">â€¢</span>
              <div>Tax-deductible in the U.S.</div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <div class="rounded-xl border border-gray-200 bg-white/70 p-6">
            <h3 class="text-lg font-semibold text-gray-800">Why your donation matters</h3>
            <ul class="mt-4 space-y-3 text-gray-700">
              <li class="flex items-start">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="mr-2 mt-0.5 h-5 w-5 text-green-700"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                </svg>
                Accelerates projects already making impact
              </li>
              <li class="flex items-start">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="mr-2 mt-0.5 h-5 w-5 text-green-700"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                </svg>
                Funds critical skills: engineering, design, marketing
              </li>
              <li class="flex items-start">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="mr-2 mt-0.5 h-5 w-5 text-green-700"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
                </svg>
                Helps launch new initiatives quickly and effectively
              </li>
            </ul>
          </div>

          <div class="rounded-xl border border-gray-200 bg-white/70 p-6">
            <h3 class="text-lg font-semibold text-gray-800">Alternative ways to give</h3>
            <p class="mt-3 text-gray-700">
              Donate via crypto <a
                href="https://thegivingblock.com/donate/tech-for-palestine"
                target="_blank"
                class="font-semibold text-green-700 underline hover:text-green-800">here</a
              > or email <b>donations@techforpalestine.org</b> and we'll assist you.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ isUK }}>
    // A/B Test Logic
    document.addEventListener('DOMContentLoaded', function() {
      // Check for URL parameter override (for testing)
      var urlParams = new URLSearchParams(window.location.search);
      var forceVariant = urlParams.get('variant');

      var trackingVariant;
      var formToShow;

      if (forceVariant === 'qgiv') {
        // Force show qgiv form with link
        formToShow = 'form-qgiv-link';
        trackingVariant = 'qgiv + link';
      } else if (forceVariant === 'validaid') {
        // Force show ValidAid form with link
        formToShow = 'form-validaid-link';
        trackingVariant = 'Validaid + link';
      } else {
        // Randomly assign A/B test variant (50/50 split)
        var testGroup = Math.random() < 0.5 ? 'A' : 'B';

        if (testGroup === 'A') {
          // Control: qgiv only, no link
          formToShow = 'form-qgiv-only';
          trackingVariant = 'qgiv';
        } else {
          // Variant B: Geo-targeted
          if (isUK) {
            // UK visitors: ValidAid form + link to qgiv
            formToShow = 'form-validaid-link';
            trackingVariant = 'Validaid + link';
          } else {
            // Non-UK visitors: qgiv form + link to ValidAid
            formToShow = 'form-qgiv-link';
            trackingVariant = 'qgiv + link';
          }
        }
      }

      // Show the appropriate form
      var targetForm = document.getElementById(formToShow);
      if (targetForm) {
        targetForm.style.display = 'block';
      }

      // Load appropriate scripts based on which form is shown
      if (formToShow === 'form-qgiv-only' || formToShow === 'form-qgiv-link') {
        // Load qgiv script
        (function (w, d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s);
          js.id = id;
          js.src = "https://secure.qgiv.com/resources/core/js/embed.js";
          fjs.parentNode?.insertBefore(js, fjs);
        })(window, document, "script", "qgiv-embedjs");
      } else if (formToShow === 'form-validaid-link') {
        // Handle ValidAid iframe resize
        window.addEventListener('message', function (event) {
          if (event.origin !== "https://validaid.org") return;
          if (event.data.type === 'validaid-resize' && event.data.iframeId === 'validaid-iframe-event-236') {
            var iframe = document.getElementById('validaid-iframe-event-236');
            if (iframe) {
              iframe.style.height = event.data.height + 'px';
            }
          }
        });
      }

      // Track pageview with variant (safely)
      if (typeof window.plausible !== 'undefined') {
        window.plausible('pageview', { props: { donate_form_variant: trackingVariant } });
      }
    });
  </script>
</Layout>
